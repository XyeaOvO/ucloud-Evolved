# UCloud-Evolved-Plus 脚本全面优化需求

## 1. 背景与目标
- 当前脚本版本 v0.82 已迁移至 TypeScript + Rollup 工程，源码拆分到 `src/` 目录并通过 `dist/ucloud-evolved-plus.user.js` 构建单文件输出。
- 最近一轮迭代新增 `CourseExtractor`、`DownloadManager`、`NotificationManager` 等服务模块，引入统一作业视图、通知高亮、批量打包下载等体验优化。
- 功能持续增长仍伴随复杂性快速上升，本文继续梳理现状、识别优先问题，并更新系统化优化需求及验收标准。

## 2. 现状概览
- 项目已具备基础工程化能力（TypeScript、Rollup、Tampermonkey 元数据头自动注入），源码按 `core/`、`services/`、`interceptors/`、`settings/` 等分类。
- 主入口 `src/app/ucloud-enhancer.ts` 仍承担全部页面适配、UI 渲染、业务编排、样式注入和下载控制，文件超过 4k 行且以 `@ts-nocheck` 运行。
- 核心数据访问集中在 `src/core/api.ts` 与 `src/core/storage.ts`，引入了缓存层 `Cache` 与 `Storage` 封装；`Settings` 模块提供布尔型开关的默认值加载能力。
- 大量 DOM 构建、样式注入与交互逻辑仍在运行时通过字符串模板和 `GM_addStyle` 完成，缺乏可复用组件和样式体系。

## 3. 问题评估

### 3.1 架构与可维护性
- 虽已将 API、下载、拦截器等拆分到独立模块，但 `src/app/ucloud-enhancer.ts` 仍负责页面生命周期、模板渲染、状态控制等全部职责，`@ts-nocheck` 掉类型保护，难以按功能维度测试或复用。
- `src/utils/index.ts` 继续堆叠 DOM、网络、文件、格式化、哈希等工具函数，单文件体量大且彼此耦合，调用链难以追踪；尚未形成明晰的依赖方向图。
- 模块之间仍大量通过实例字段或全局变量（如 `isBatchDownloading`, `_homeworkSkeletonCleanup`）共享状态，缺乏显式生命周期钩子。

### 3.2 状态与数据管理
- `Settings` 模块虽封装默认值加载，但仅支持布尔值，且缺少 schema、版本升级与合法性校验；导入导出、灰度开关仍需手动扩展。
- `Storage` 与 `API` 之间仍通过 `GM_getValue` 与内存缓存并行维护数据，没有统一的数据源声明和失效策略描述；缓存指标不可见。
- 新增的统一作业回收站、批量打包等特性直接写 GM 存储，不具备批量清理、诊断、迁移工具。

### 3.3 DOM 与交互实现
- `createUnifiedHomeworkView`、`showTrashBin`、`createUI` 等方法手写大量 HTML 字符串或直接操作 DOM API，缺乏模板/组件抽象，复用与重构成本高。
- 样式仍由 `GM_addStyle` 在各方法中多次注入，缺少命名约定及冲突检测；主题、弹窗、trash modal 等样式难以复用或按需加载。
- 页面观察者、事件监听仍由 `UCloudEnhancer` 手动维护，部分流程（如通知页面、高频 MutationObserver）缺少统一注册/销毁机制。
- 设置面板 UI 仍通过一次性 `innerHTML` 模板和逐项 `querySelector` 绑定（见 `src/app/ucloud-enhancer.ts` 约 2400 行），新增的回收站清理按钮等动作需要手工接线，无法依据 `SETTINGS_SECTIONS` 自动渲染/收敛逻辑，扩展成本高。
- `HomeworkModule`/`HomeworkPanelView` 虽已拆分核心渲染，但确认弹窗、trash modal 等仍以内联模板字符串和多段 `GM_addStyle` 注入组合，缺乏可复用的样式/组件层，导致 CSS/HTML 体积持续膨胀且难以测试。
- ✅ 最新进展：`HomeworkModule` 现已将统一作业面板的 DOM 渲染与事件绑定全部委托给独立的 `HomeworkPanelView` 组件类，去除了手写监听/查询和临时定时器，实现回收站计数、搜索过滤等逻辑的集中管理，为后续模板化奠定基础。

### 3.4 性能与资源消耗
- 统一作业视图与课程抽取在哈希路由切换时重复拉取数据，缺少对已有缓存快照的增量复用与预加载控制；`API.searchCourses` 仍可能对每个作业逐个请求任务列表。
- 批量打包下载依赖 JSZip in-memory 生成全文档，面对大课件目录时内存峰值无法控制，也缺少对文件数量/体积的预估反馈。
- 作业、课程、预览相关 DOM 渲染均为同步操作，缺少分页/虚拟化或调度策略，首屏渲染过程中仍可能引发卡顿。

### 3.5 下载与预览流程
- `DownloadManager` 已具备队列和 GM/fetch 双通路，但并发控制、任务状态变更、错误重试等能力未完全抽象给调用方，新接口仍需在 `UCloudEnhancer` 内部手动维护 `isBatchDownloading` 等标志。
- 批量打包逻辑直接在 `UCloudEnhancer` 实现，缺少队列化模型、进度广播与取消反馈的清晰边界，难以在其他场景复用。
- 预览 URL 获取仍穿插于页面逻辑中，没有统一的资源模型（文件类型、鉴权信息、回退策略），导致重复的容错分支。
- ✅ 新增 `handleCourseHome` 逻辑，对课程主页资源列表重新注入打包下载按钮并利用 `API.getSiteResources` 数据源；siteId 解析默认使用课程缓存，缺失时回退读取 URL 参数，并修复调试菜单开关（通过 `setDebugFlag`）以恢复批量打包、全部下载、预览自动下载等功能。

### 3.6 稳定性与观测
- `LOG` 模块仅区分 debug/info/warn/error，未建立错误等级、场景标签、埋点上报；无法得知下载/预览/作业渲染成功率。
- 大量 Promise 链缺少超时与兜底（例如 `openPreview`、`createImageViewer`），任一异常都可能中断当前功能而无回退路径。
- 缺乏自动化测试覆盖，重构后的模块尚未建立最小单元测试，回归风险仍高。

### 3.7 工程化与协作
- 目前仅提供 `rollup` 构建与 watch 脚本，缺少 ESLint/Prettier、规范化 commit、单元/集成测试脚本；多人协作难以保持风格一致。
- 版本号、Tampermonkey 元数据、资源哈希仍需手动维护，构建产物校验与发布流程未自动化。
- README/贡献指南尚未更新新版工程结构与调试指引，外部贡献门槛依旧高。

### 3.8 类型与可读性
- `@ts-nocheck` 覆盖整个 `ucloud-enhancer.ts`，`Utils`、`CourseExtractor` 等仍大量使用 `any`/`unknown`，类型安全缺失。
- Tampermonkey API、UCloud 数据模型未形成共享的类型定义（如 `AssignmentSummary` 仍为可选属性 + `unknown` 字段），阅读和重用困难。
- 缺乏对关键模块（下载、缓存、设置）的 API 文档和使用示例，影响后续维护。

## 4. 优化需求

> 状态标记说明：`[x]` 已完成 · `[~]` 部分完成/进行中 · `[ ]` 待处理

### 4.1 架构与代码组织
- [x][R1] 建立 TypeScript/ESM 模块化工程，通过 Rollup 构建单一用户脚本输出。
- [~][R2] 拆分 `Utils` 为多文件工具集并明确依赖方向（已集中至独立模块，但仍为单文件，需按领域拆分 DOM/网络/文件等）。
- [~][R3] 将拦截器、主题/样式、页面适配器、下载服务等独立为子模块（已抽离部分服务，但 `UCloudEnhancer` 仍耦合 UI + 业务，缺少独立入口与生命周期管理）。
- [ ][R25] 解构 `ucloud-enhancer.ts`：按页面/功能拆分（首页、课程、作业、通知、下载），去除 `@ts-nocheck`，形成可测试的子模块与路由调度层。
- [ ][R26] 为核心域对象（课程、作业、资源、下载任务）建立共享类型与仓库接口，减少 `unknown`/`any` 传递。

### 4.2 状态、缓存与配置
- [ ][R4] 设计可扩展的设置项 schema（默认值、类型、版本迁移），支持导入导出和灰度开关。
- [ ][R5] 引入轻量状态容器（store），统一 GM 存储、内存缓存与 DOM 观察同步逻辑。
- [ ][R6] 建立缓存策略声明（TTL、容量、命中率），提供调试面板和一键清理。
- [ ][R27] 为作业回收站、批量下载配置等新增存储制定统一的 persistence API，支持批量清理与迁移。

### 4.3 DOM、样式与交互
- [ ][R7] 引入模板/组件层（lit-html、hyperscript 或编译期 JSX），替换手写 `innerHTML` 与重复 DOM 查询。
- [ ][R8] 建立样式模块和命名约定，构建期合并并避免重复注入；将主题变量、通用组件样式抽离。
- [ ][R9] 实现统一的 Observer/事件注册管理器，自动处理路由切换与销毁。
- [~][R28] 为统一作业视图、trash modal、设置面板封装 UI 组件与状态机（已抽离 `HomeworkPanelView` 管理统一作业视图的渲染、交互与回收站同步，下一步需要引入模板化 DOM 与其它面板的组件化）。
- [ ][R29] 提供首屏渐进渲染策略（如骨架屏组件化、分页/虚拟滚动支持）。
- [ ][R34] 将设置面板改造成数据驱动的组件：根据 `SETTINGS_SECTIONS` 自动渲染分组/动作，集中事件绑定与状态同步，支持后续新增字段与输入类型。

### 4.4 下载与资源处理
- [~][R10] 重构下载任务模型，支持队列、并发限制、可取消、进度通知及错误重试（已实现基础队列和并发控制，但任务生命周期仍分散在调用方）。
- [~][R11] 统一预览 URL 获取与鉴权逻辑，补充失败提示与人工重试选项（API 层已集中，但页面逻辑仍散落在多个方法，fallback 处理未统一）。
- [ ][R12] 批量打包改为流式/分片写入，控制内存峰值，并提供文件名策略配置。
- [ ][R30] 抽象批量操作（批量下载/打包/同步）任务中心，支持状态查询、取消、retry 与用户提示。

### 4.5 性能与可用性
- [x][R13] 为高频 API 增加缓存与重试（课程、通知已加入 TTL 缓存与 GM 存储回填）。
- [x][R14] 优化 `Utils.wait` 等等待工具，支持自定义 timeout、onTimeout、日志输出。
- [ ][R15] 提升首页/课程页首屏性能（异步渲染、任务分批处理、骨架屏组件化）。
- [ ][R31] 为作业列表和课程列表提供分页/搜索缓存，避免重复调用 `API.searchCourses`。

### 4.6 稳定性、监控与回滚
- [ ][R16] 建立分级日志与诊断导出能力，支持 DEBUG/INFO/ERROR 过滤与用户反馈导出。
- [ ][R17] 为关键流程添加断言与异常捕获，支持降级模式（如禁用增强功能时回退到原生页面）。
- [ ][R18] 建立功能开关体系（feature flag），配合 GM 菜单或设置面板快速回滚新特性。

### 4.7 工程化与发布流程
- [ ][R19] 引入包管理工具规范（pnpm/yarn workspace）、ESLint/Prettier、Commitlint。
- [~][R20] 优化打包脚本（已自动注入元信息，但版本同步、资源哈希更新、bundle 校验仍需完善）。
- [ ][R21] 更新 README/CONTRIBUTING，补充工程结构、调试方式、发布流程文档。
- [ ][R32] 为 Tampermonkey 元数据、资源依赖建立自动校验任务，防止漏更新。

### 4.8 测试与质量保障
- [ ][R22] 为核心模块（API、Cache、DownloadManager、Settings）编写单元测试。
- [ ][R23] 设计关键页面的集成测试脚本（Playwright/Automation）验证 DOM 注入与交互。
- [ ][R24] 引入 CI（GitHub Actions），集成 lint/test/build 校验。
- [ ][R33] 建立最低限度的 smoke test（构建后自动运行关键脚本片段），验证打包产物可执行。

## 5. 里程碑与交付物
- **M1（进行中）**：工程化脚手架与基础模块拆分。已完成 TypeScript + Rollup 构建链路、核心服务模块化、通知拦截与下载队列改造；待完成事项包括拆分 `ucloud-enhancer.ts`、移除 `@ts-nocheck`、细化工具模块与类型定义。
- **M2**：核心功能重构与稳定性建设（预计 ~3 周）。目标：完成下载/课程/作业/通知主流程抽象与单元测试、实现批量任务中心与统一错误处理，交付可测试的模块化代码与测试报告。
- **M3**：体验优化、监控埋点与 CI 流程（预计 ~2 周）。目标：完善 UI/主题模块化、引入性能优化与日志体系、完成文档/CI/发布脚本，交付发布版脚本、ChangeLog、回滚方案。
- **后续建议**：在 M3 之后安排一轮代码走查与覆盖率评估，确认 `@ts-nocheck` 与大型工具模块全部退场，再规划外部贡献指南。

## 6. 风险与注意事项
- 页面结构仍可能变动，需提前准备监控与 Feature Flag 以降低线上回滚成本。
- 批量打包依赖 JSZip 全量缓存，面对大文件目录可能触发内存/浏览器限制，应尽早实现分片/流式方案或加入容量提示。
- `@ts-nocheck` 与缺失的类型定义导致静态分析失效，重构前应逐步补齐类型和最小化测试，以防引入隐性回归。
- GM_* API 仍与浏览器行为混用，在模块化与打包过程中需持续验证兼容性矩阵。
- 大量样式/DOM 在运行时注入，若未建立统一前缀可能与官方页面样式冲突，需在后续样式体系设计中解决。
